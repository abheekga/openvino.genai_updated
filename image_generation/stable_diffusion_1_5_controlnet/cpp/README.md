# stable diffusion 1.5 controlnet pipeline

The pure C++ text-to-image and image-to-image pipeline, driven by the OpenVINO native C++ API for Stable Diffusion v1.5 with LMS Discrete Scheduler and Openpose.

## Step 1: Setup Environment

Prerequisites:
- Conda ([installation guide](https://conda.io/projects/conda/en/latest/user-guide/install/index.html))

C++ Packages:
* [CMake](https://cmake.org/download/): Cross-platform build tool
* [OpenVINO](https://docs.openvino.ai/install): Model inference. `master` and possibly the latest `releases/*` branch correspond to not yet released OpenVINO versions. https://storage.openvinotoolkit.org/repositories/openvino/packages/nightly/ can be used for these branches early testing.

Prepare a python environment and install dependencies:

```shell
conda create -n ov_sd_controlnet python==3.11
conda activate ov_sd_controlnet
pip install -r ../../common/detectors/scripts/requirements.txt
pip install -r scripts/requirements.txt
```

## Step 2: Convert Models

1. Convert tokenizer

```shell
pip install openvino-tokenizers

convert_tokenizer openai/clip-vit-large-patch14 --with-detokenizer -o models/tokenizer
```

2. Convert the rest of models

```shell
python scripts/convert_sd_controlnet.py
```

It will download missing models and convert them into openvino models.

## Step 3: Build the Application

On windows, we should install openvino and opencv first.

- openvino: follow the instruction [here](https://docs.openvino.ai/2024/get-started/install-openvino/install-openvino-archive-linux.html)
- opencv: download the latest release version and install to somewhere on your PC(for example `D:\opencv\`).

then open commandline prompt(x86 Native Tools Command Prompt for VS 2022)

```shell
"C:\Program Files (x86)\Intel\openvino_2024\setupvars.bat"
"D:\opencv\opencv\build\setup_vars_opencv4.cmd"

cmake -S . -B build -DOpenCV_DIR="D:\opencv\opencv\build" -DOpenVINO_DIR="C:\Program Files (x86)\Intel\openvino_2024\runtime\cmake"

cmake --build build --parallel --config Release
```

## Step 5: Run Pipeline

Using `-h` to check all the options, here is a simple image-to-image example.


```shell
.\build\Release\stable_diffusion_controlnet.exe -p "Dancing Darth Vader, best quality, extremely detailed" -n "monochrome, lowres, bad anatomy, worst quality, low quality" -i ".\scripts\pose.png" -s 42 --step 20 -d GPU
```

## Step 6: Verify Results

There's a [notebook](./scripts/verify.ipynb), you can just run the notebook and check the results generated by cpp and python.
